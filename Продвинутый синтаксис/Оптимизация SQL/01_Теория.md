# Теория оптимизации

## Почему в SQL важна эффективность запроса, а не только правильность?

**Ключевой тезис:** В SQL недостаточно написать запрос, который просто возвращает правильный результат. Его производительность критически зависит от **плана выполнения**, который генерирует СУБД.

**Основная причина: декларативная природа SQL**

| Аспект | SQL (Декларативный) | Императивный код (Java, Python и др.) |
| :--- | :--- | :--- |
| **Описание** | **"Что" получить** (конечный набор данных) | **"Как" получить** (конкретная последовательность команд) |
| **Исполнитель** | Оптимизатор СУБД | Интерпретатор/компилятор языка + программист |
| **Контроль** | Программист задает цель, СУБД сама выбирает алгоритм | Программист полностью контролирует алгоритм |

**Следствие:** Два логически эквивалентных SQL-запроса, возвращающих **одинаковый результат**, могут иметь **разные планы выполнения** и, как следствие, кардинально различаться по скорости (от миллисекунд до часов).

**Пример проблемы:**
```sql
-- Запрос 1 (с подзапросом) -- Может выполняться медленно
SELECT * 
  FROM orders
 WHERE customer_id IN (SELECT id 
                         FROM customers 
                        WHERE status = 'active');
```
```sql
-- Запрос 2 (с JOIN) -- Может выполняться быстро
SELECT o.* 
  FROM orders o
  JOIN customers c ON o.customer_id = c.id
 WHERE c.status = 'active';
```

## Пошаговый алгоритм оптимизации в рамках БД
1) определить этап, на котором возникла проблема  
2) выяснить причину снижения производительности  
3) подобрать метод оптимизации 

### Уровень SQL-запроса
Найти причину на уровне SQL можно проанализировав скорость выполнения запроса, например через модуль `pg_stat_statements`.  

Определив, что запрос является медленным можно сделать:  
1) **анализ структуры запроса** - возможно из-за неэффективности структуры его стоит перестроить  
2) **анализ самого запроса** - можно начасть с условий фильтрации и соединения  
3) **избавиться от лишних данных в запросе** - лишние данные = лишнее время выполнения запроса 

### Уровень структуры БД
Для выявления проблем в структуре БД можно:  
1) **Анализ структуры БД** - необходимо проанализировать структуру. Нет ли лишних данных, хорошо ли нормализована  
2) **Анализ типов данных** - размер таблицы может необоснованно расти из-за перегрузки таблиц некорректными типами данных
3) **Партицирование таблиц** - большие таблицы можно разбить на партиции по признаку, чтобы запрос сканировал не всю таблицу а лишь конкретную партицию  

