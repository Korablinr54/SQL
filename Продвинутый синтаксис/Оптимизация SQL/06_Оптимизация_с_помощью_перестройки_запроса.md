# Оптимизация трафика

Одна из причин медленной работы БД - неоптимальные запросы.  

## Экономия трафика (база -> приложение)

### пример 1
Самый очевидный способ оптимизации. Чтобы сократить время выполнения запроса нужно уменьшить количество передаваемой информации.  

Например, нужно вывести номер и дату заказа.  
```sql
SELECT * 
  FROM orders 
 WHERE 1 = 1
   and customer_id = ? 
-- ? означает переменное значение, подставляемое в запрос
```
Запрос решает задачу но есть проблема, в выоде присуствует слишком много лишних полей. К тому же хорошей практикой является явное перечисление колонок даже если нужны все.

```sql
SELECT id, date 
  FROM orders 
 WHERE 1 = 1 
   and customer_id = ?
-- вернет только те данные, которые необходимы
```

### пример 2
Например, нам нужно определить факт наличия заказов у покупателя, если есть хотя бы один заказ.
```sql
SELECT id 
  FROM orders 
 WHERE 1 = 1
   and customer_id = ?;
```
Запрос решает проблему, но возвращает избыточное количество данных. Нам нужно просто понимать, есть ли у клиента хотя бы один заказ, а не видеть все его заказы.

```sql
SELECT id 
  FROM orders 
 WHERE 1 = 1 
   and user_id = ?
 LIMIT 1;
```
Ограничим выборку одной строкой, нас это вполне устроит и никаких лишних данных.

### пример 3

Необходим объект для расчета количества заказов и их средней стоимости.
```sql
SELECT category, 
       amount, 
       price 
  FROM orders o
  JOIN products p ON o.product_id = p.id
 WHERE 1 = 1
   and o.created_at BETWEEN first_of_month AND last_of_month;
```

Как и ранее запрос выполняет возложенные на него условия, но это буквально передача тысяч строк. А можно расчитать все на стороне БД и передавать уже готовый результат.

```sql
SELECT category,
       COUNT(*) as orders_count, 
       AVG(amount * price) as average_sum
  FROM orders o
  JOIN products p ON o.product_id = p.id
 WHERE 1 = 1
   and  o.created_at BETWEEN first_of_month AND last_of_month
 GROUP BY category;
```

