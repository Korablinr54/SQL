# JSON

`json` — это текстовый формат, который может содержать две сущности:  
* Объект json.  
* Массив.  

## Объект JSON  
Основу структуры JSON составляет объект, представленный в виде неупорядоченного множества пар «ключ: значение». Данные заключаются в фигурные скобки `{}`, а элементы внутри разделяются запятыми. В качестве наглядного примера можно рассмотреть JSON-объект, содержащий информацию о сотруднике:  

```sql
{
    "Имя": "Иван",
    "Фамилия": "Ивано",
    "Год ролждения": 1975
}
```

В роли ключей допустимы исключительно строковые значения, обязательно заключенные в кавычки. Именно эта строгая нотация применяется в СУБД PostgreSQL для работы с JSON-данными.  
В отличие от него, существуют иные стандарты сериализации данных, такие как JSON5, где правила менее строгие. К примеру, в JSON5 ключом может выступать число, и в таком случае его заключать в кавычки не требуется.  

Что касается значений в JSON-объекте, их тип может быть одним из следующих:  
* Строка (в кавычках)  
* Число (целое или с плавающей точкой)  
* Булев тип (true или false)  
* Массив (упорядоченный список значений в квадратных скобках)  
* Вложенный JSON-объект (набор пар ключ-значение в фигурных скобках)  

Объекты JSON поддерживают вложенность, например:  
```sql
{
    "Имя": "Иван",
    "Фамилия": "Ивано",
    "Год ролждения": 1975,
    "Дети" : {
             "Имя":"Алексей",
              "Год рождения": 2000
    }
}
```  

## Массив JSON
Массив JSON практически то же, что и обычный массив. Пример такого массива:  
```sql
[
    {
        "название": "Смартфон",
        "цена": 29999,
        "категория": "Электроника",
        "вНаличии": true
    },
    {
        "название": "Кофемашина",
        "цена": 45990,
        "категория": "Бытовая техника",
        "вНаличии": false
    },
    {
        "название": "Футболка",
        "цена": 2499,
        "категория": "Одежда",
        "вНаличии": true
    }
]
```  
Массив может быть вложен в объект:  
```sql
{
    "имя": "Иван",
    "дети": [
        {
            "имя": "Алёна"
        },
        {
            "имя": "Макар"
        }
    ],
    "возраст": 25,
    "фамилия": "Иванов"
}
```

# JSONB
Выглядит также как и обычный JSON о данные хранит в бинарном формате, отсюда такое название.  
| Критерий | JSON | JSONB |
| :--- | :--- | :--- |
| **Работа с сохранением** | | |
| Формат хранения | Сохраняет точную текстовую копию | Сохраняет в разобранном двоичном виде |
| Незначимые пробелы | Сохраняются | Удаляются |
| Повторяющиеся ключи | Сохраняются все (при выборке возвращается последний) | Сохраняется только последний |
| **Скорость** | | |
| Порядок ключей | Сохраняется | Не сохраняется |
| Скорость записи (ввода) | **Выше** (простое сохранение текста) | **Ниже** (затраты на бинарный разбор и преобразование) |
| Скорость чтения (обработки) | **Ниже** (требуется повторный разбор) | **Выше** (данные готовы для обработки) |
| **Функциональность** | | |
| Поддержка индексации | Нет | **Да** |
| Операторы (конкатенация, вхождение и др.) | Нет | **Да** |
| Функции для изменения ключей/значений | Нет | **Да** |

# Объявление полей JSON
```sql
ALTER TABLE test.clients ADD COLUMN worksheet_json json;
ALTER TABLE test.clients ADD COLUMN worksheet_jsonb jsonb;
```

# Создание json/jsonb
```sql
 INSERT INTO test.clients (id, name, email, phone, add_phone, worksheet_jsonb, worksheet_json)
 values(
 gen_random_uuid(),
 'Колесов Игорь Витальевич',
 'proverka@mail.ru',
 9609469976,
 '{{9609469979}, {9609469978}}',
'{
       "name": "Колесов Игорь Витальевич",
       "birth_date": "12.06.1985",
       "children": [
           {
               "relationship": "сын",
               "name": "Колесов Артем"
           },
           {
               "relationship": "дочь",
               "name": "Колесова Инна"
           }
       ]
    }', -- вставьте значение в столбец с типом jsonb
    '{
       "name": "Колесов Игорь Витальевич",
       "birth_date": "12.06.1985",
       "children": [
           {
               "relationship": "сын",
               "name": "Колесов Артем"
           },
           {
               "relationship": "дочь",
               "name": "Колесова Инна"
           }
       ]
    }' -- вставьте значение в столбец с типом json
)
```

# Операторы для работы с JSON и JSONB

## Чтение из json/jsonb
Например, нужно извлечь имя из json-поля:
```sql
SELECT worksheet_json -> 'name' -- вернет объект json, текст будет заключен в кавычки
  FROM test.clients;

SELECT worksheet_json ->> 'name' -- вернет текст
  FROM test.clients;
```

Результат:  
* в первом случае: `"Колесов Игорь Витальевич"`  
* во втором случае: `Колесов Игорь Витальевич`

Можно использовать индексацию (начинается с 0) для получения элемента. Например:
```sql
SELECT worksheet_json -> 'children' -> 0  
  FROM test.clients;  
-- вернет: {  
               "relationship": "сын",  
               "name": "Колесов Артем"  
           }  

-- или используя отрицательную индексацию вернем первый элемент с конца  
SELECT worksheet_json -> 'children' -> -1    
  FROM test.clients;    

-- результат:  {  
                  "relationship": "дочь",  
                  "name": "Колесова Инна"  
               }  
```

По аналогии можно использовать такую запись, указать вложенные массив и индекс:  
```sql  
SELECT worksheet_json::jsonb #>> '{children, 0}'  
  FROM test.clients;  
-- вернет: {"name": "Колесов Артем", "relationship": "сын"}
```

## Функции для работы с jsonb  
### Конкатенация  

Конкатенация позволяет объединить два jsonb объекта, обратите внимание на кавычки:  
```sql  
SELECT worksheet_jsonb::jsonb || '{"eye_color" : "blue"}'::jsonb  
  FROM test.clients;  
```

Результат:   
```json  
{  
  "name": "Колесов Игорь Витальевич",  
  "children": [  
    {  
      "name": "Колесов Артем",  
      "relationship": "сын"  
    },  
    {  
      "name": "Колесова Инна",  
      "relationship": "дочь"  
    }  
  ],  
  "eye_color": "blue",  
  "birth_date": "12.06.1985"  
}  
```
* в jsonb порядок расположения объектов в запросе не гарантирует результат в итоговом наборе, т.к. jsonb не сохраняет порядок ключей.  