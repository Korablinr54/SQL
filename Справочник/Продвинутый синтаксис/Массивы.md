# Массивы
## Определение
**Массив** — это упорядоченная коллекция элементов одного типа данных.  

Ключевые особенности массивов в PostgreSQL:  
* **Однотипность элементов** Все элементы массива должны быть одного типа (например, только числа, только строки и т. д.).  
* **Индексируемость** Каждый элемент имеет свой индекс (порядковый номер), начиная с 1 (или с 0, если используется специальная настройка). Доступ к элементам осуществляется по индексу: имя_массива[индекс].  
* **Гибкость хранения данных** Массивы полезны, когда нужно хранить список значений в одной ячейке таблицы.  

Например, в базе данных сервиса такси можно хранить дополнительные номера телефонов клиента в виде массива, в то время как основной номер хранится отдельно.  

| Критерий               | Массив в одной колонке (`add_phones`) | Отдельная таблица (`client_phones`) |
|------------------------|---------------------------------------|-------------------------------------|
| **Дублирование данных** | Нет дублирования данных клиента       | Требует хранения `client_id` для каждой записи |
| **Сложность запросов**  | Простые выборки                      | Требует JOIN для объединения данных |
| **Гибкость**           | Только хранение номеров              | Можно добавить атрибуты (тип, дата и т.д.) |
| **Производительность** | Лучше для небольших наборов данных   | Лучше для больших наборов данных и сложных запросов |
| **Масштабируемость**   | Плохо для >15 элементов              | Хорошо для любого количества записей |
| **Использование**       | Простые случаи (доп. номера без метаданных) | Сложные случаи (нужна доп. информация о номерах) |

| id | client_name          | phone      | add_phones                     |
|----|----------------------|------------|--------------------------------|
| 1  | Иванов Петр Сергеевич | 79991234567 | {79167654321, 79035671234}     |
| 2  | Смирнова Анна Дмитриевна | 79876543210 | {79991112233, 79213457689}     |
| 3  | Козлов Денис Викторович | 79780001122 | {79152223344}                 |  

Без массива пришлось бы создавать отдельную таблицу для номеров, например:  
| client_id | phone_type | phone      |
|-----------|------------|------------|
| 1         | main       | 79991234567|
| 1         | additional | 79167654321|
| 1         | additional | 79035671234|  

## Одномерный массив
Одномерный массив можно представить как некую последовательность. Каждый элемент в нём определяют с помощью одного индекса.  
| Индекс | 1 | 2 | 3 | 4 | 5 |
|--------|---|---|---|---|---|
| Элемент | C | f | s | p | v |

 id | client_name          | phone      | add_phones               |
|----|----------------------|------------|--------------------------|
| 1  | Иванов П.С.          | 79991234567 | {'79167654321','79035671234'} |
| 2  | Смирнова А.Д.        | 79876543210 | {'79991112233'}          |

**Характеристики**:  
* Размерность: 1  
* Размер: 5 элементов  

## Двумерный массив
Многомерный массив — это буквально «массив из массивов». Так, двумерный массив — это массив одномерных массивов.  

| Индекс \ Номер массива | 1 (Массив №1) | 2 (Массив №2) | 3 (Массив №3) |
|------------------------|---------------|---------------|---------------|
| **1**                  | с             | w             | e             |
| **2**                  | f             | a             | r             |
| **3**                  | s             | x             | s             |
| **4**                  | p             | t             | f             |  

| id | client_name    | phone      | phones_with_labels                     |
|----|----------------|------------|----------------------------------------|
| 1  | Козлов Д.В.    | 79780001122 | {{'work','79152223344'},{'home','79001112233'}} |
| 2  | Петрова М.К.   | 79654321098 | {{'emergency','79990001122'}}          |  

**Характеристики**:  
* Размерность: 2  
* Размер №1 (строки): 4  

## Трехмерный массив
| Уровень \ Срез | Срез №1       | Срез №2       | Срез №3       |
|----------------|---------------|---------------|---------------|
| **Слой 1**     | [a, b, c]     | [d, e, f]     | [g, h, i]     |
| **Слой 2**     | [j, k, l]     | [m, n, o]     | [p, q, r]     |  

| id | client_name    | current_phone | phone_history                                                                 |
|----|----------------|---------------|-------------------------------------------------------------------------------|
| 1  | Сидоров В.П.   | 79160000000   | {{{'2020-01','79161111111'},{'2021-05','79162222222'}},{{'2023-01','79160000000'}}} |
| 2  | Николаева Л.Р. | 79250000000   | {{{'2021-02','79251111111'}},{{'2022-03','79252222222'},{'2023-04','79250000000'}}} |

**Характеристики**:  
* Размерность: 3  
* Размер №1 (срезы): 3  
* Размер №2 (слои): 2  
* Размер №3 (элементы): 3  

## Особенности массивов в PostgreSQL
| Характеристика          | Описание в контексте PostgreSQL                                                                 |
|-------------------------|------------------------------------------------------------------------------------------------|
| **Типы данных**         | Могут быть любые: `INTEGER[]`, `TEXT[]`, `VARCHAR(11)[]`, `BOOLEAN[]` и пользовательские типы |
| **Индексация**          | Начинается с **1** (не с 0). Пример: `array_name[1]` — первый элемент                          |
| **Динамичность**        | Размер/размерность меняется автоматически при добавлении элементов                             |
| **Гибкость размерности**| В одной колонке могут сосуществовать массивы разной размерности (1D, 2D и т.д.)               |

# Создание массивов

При объявлении (создании) поля с типом данных «массив» используют указание типа данных элементов массива (здесь это text) и квадратные скобки `[]` или слово `ARRAY`.  
```sql
  DROP TABLE IF EXISTS Arrays; 
CREATE TABLE arrays (
       id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
       first_name varchar(128),
       last_name varchar(128),
       primary_phone bigint UNIQUE CHECK (primary_phone > 0),
       secondary_phone bigint[] -- Вместо квадратных скобок можно использовать ключевое слово ARRAY:
);
```

Для создания многомерного массива нужно изменить количество `[]` по количеству измерений. При этом ни использование двух пар квадратных скобок, ни указание размера по каждому измерению не несут никаких дополнительных преимуществ. Вы также сможете вставить в таблицу, созданную последним скриптом, трёхмерный массив с десятью элементами в каждом измерении.  
```sql
DROP TABLE IF EXISTS arrays;
CREATE TABLE arrays (
       id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
       first_name varchar (128),
       last_name varchar (128),
       phone bigint UNIQUE CHECK (phone > 0),
       email varchar (128) UNIQUE,
       antropometry varchar (32) [][] -- двумерный массив
       );
```

# Вставка элементов массива
Есть два варианта синтаксиса при формировании массива:  
* Фигурные скобки `{}`;  
* Конструктор `ARRAY`.  
```sql
INSERT INTO arrays (first_name, last_name, phone, email, antropometry)
VALUES
('Иван', 'Замочников', 89609471899, 'example@yandex.ru', '{{Рост, 175}, {Вес, 75}, {Цвет волос, Русый.}}'),
('Алексей', 'Кузнецов', 89609731899, 'example@rambler.ru', ARRAY[['Рост', '180'], ['Вес', '90'], ['Цвет волос', 'Черный']])
```  
| id                                   | first_name | last_name  | phone       | email               | antropometry                               |
|--------------------------------------|------------|------------|-------------|---------------------|--------------------------------------------|
| 2a672311-d240-4eb9-90df-1c8fd7977b47 | Иван       | Замочников | 89609471899 | example@yandex.ru   | {{Рост,175},{Вес,75},{"Цвет волос",Русый}} |
| 834fac8c-0e58-4600-8d87-a5e9bfaf567b | Алексей    | Кузнецов   | 89609731899 | example@rambler.ru  | {{Рост,180},{Вес,90},{"Цвет волос",Черный}} |

**Внимание**:  
1. Метод с фигурными скобками `{}`  
PostgreSQL видит это как единую строку, которая будет преобразована в массив только при вставке в таблицу. На этапе парсинга SQL это просто текст, поэтому числа без кавычек не вызывают ошибки.  
2. Метод с конструктором `ARRAY` - немедленная проверка типов  
PostgreSQL немедленно пытается создать массив и проверить типы данных. Здесь 'Рост' - строка, а 180 - число. Это смешение типов вызывает ошибку, так как массив не может содержать элементы разных типов.  