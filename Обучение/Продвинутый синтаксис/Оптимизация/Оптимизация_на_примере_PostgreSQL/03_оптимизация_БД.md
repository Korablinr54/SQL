# Методы оптимизации на уровне структуры БД

После выявления медленных SQL-запросов с помощью `pg_stat_statements` можно переходить к оптимизации на уровне структуры базы данных. Рассмотрим основные методы.  

## Выбор оптимальных типов данных

Правильный выбор типов данных снижает объём хранимой информации, что ускоряет передачу данных и уменьшает нагрузку на диск.  

Примеры:  
* Поле `email` в таблице `users` - Используйте `varchar(100)` или `text` вместо `char(100)`, чтобы хранить только реальную длину строки, а не фиксированный объём.

* Целочисленные типы - Если значения поля не превышают 32767, применяйте `smallint` (2 байта) вместо `int` (4 байта) или `bigint` (8 байт).
Пример: поле `items_cnt` (количество товаров в корзине будет навернякак меньше 32767) в таблице `orders`.

* Финансовые данные - Для полей вроде `price` ограничивайте точность: `numeric(10,2)` вместо неограниченного `numeric` — это сократит занимаемое место.

* `UUID`-идентификаторы - Используйте тип `uuid` (16 байт), а не `varchar(36)` (36 байт). На больших таблицах это даст существенную экономию.

## Добавление ограничения UNIQUE

Если поле должно быть уникальным по бизнес-логике (например, email пользователя), наложите ограничение `UNIQUE`. Это не только обеспечит целостность данных, но и создаст индекс, что ускорит поиск: СУБД остановит сканирование после первого найденного совпадения.

## Создание материализованных представлений

Подходит для сложных и редко меняющихся отчётов (например, ежедневная статистика продаж).  
Материализованное представление сохраняет результат запроса на диске и обновляется только по команде `REFRESH MATERIALIZED VIEW ....`  
Важно: метод эффективен лишь для статичных или исторических данных, так как при частых изменениях потребуется постоянное перестроение.

## Изменение структуры базы данных

### Удаление ненужных полей

Если в таблице есть неиспользуемые данные (например, устаревшие поля), их следует удалить.

### Денормализация

При частых и медленных `JOIN` по множеству таблиц можно преднамеренно дублировать данные, чтобы уменьшить количество объединений.
Варианты:  
- Добавить в существующую таблицу поля из других таблиц (например, `email` из `users` в `orders`).
- Создать новую таблицу, объединяющую часто запрашиваемые данные.

Недостатки денормализации:  

- Увеличение занимаемого места;  
- Усложнение операций обновления/удаления (нужно синхронизировать все копии данных);  
- Рост сложности кода.  

Рекомендация: применяйте денормализацию только при значительном замедлении работы системы, когда выигрыш в скорости чтения оправдывает перечисленные издержки.  

## Итог
Оптимизация структуры БД включает:  
- Корректировку типов данных для экономии места.  
- Добавление UNIQUE-ограничений для ускорения поиска.  
- Использование материализованных представлений для тяжёлых отчётов.  
- Денормализацию — как крайнюю меру для ускорения сложных запросов.  